<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Nexa ERP | Malhotra Classes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0e14; color: #fff; overflow-x: hidden; }
        .nexa-glass { background: #151921; border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; }
        .tab-content { display: none; }
        .active-tab { display: block; animation: slideUp 0.3s ease; }
        input { background: #1e232d !important; border: 1px solid #2d3545 !important; color: #fff !important; padding: 12px !important; border-radius: 12px !important; width: 100%; outline: none; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .btn-gradient { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    </style>
</head>
<body class="dark-mode">

<div id="lockScreen" class="fixed inset-0 z-[9999] bg-[#0b0e14] flex items-center justify-center p-6 text-center">
    <div class="nexa-glass p-8 w-full max-w-sm border-t-4 border-indigo-600 shadow-2xl">
        <div class="w-16 h-16 bg-indigo-600/10 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-500 text-2xl"><i class="fas fa-lock"></i></div>
        <h2 class="text-2xl font-black text-white mb-1 italic">MALHOTRA CLASSES</h2>
        <p id="secMsg" class="text-[9px] text-slate-500 mb-8 uppercase font-bold tracking-[3px]">Security Access Required</p>
        <div class="space-y-4">
            <input type="password" id="mKey" placeholder="License Key" class="text-center font-bold tracking-widest">
            <button onclick="unlockApp()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase text-xs shadow-lg">Unlock System</button>
            <div id="trialArea" class="hidden">
                <button onclick="enterApp()" class="w-full bg-slate-800 border border-slate-700 py-4 rounded-xl font-black uppercase text-[10px] text-indigo-400 mt-2">Trial Mode</button>
            </div>
        </div>
        <p class="text-[8px] text-slate-600 mt-6 uppercase font-bold">Powered by Khagesh ai-nexa</p>
    </div>
</div>

<div id="appUI" class="p-4 max-w-lg mx-auto pb-40" style="display: none;">
    <header class="py-6 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-indigo-500 italic">Malhotra Classes</h1>
            <p class="text-[8px] text-slate-500 font-bold uppercase">Accounts Villa, Burari</p>
        </div>
        <div class="flex gap-2">
            <button onclick="exportFullMasterPDF()" title="Download Full Master Report" class="w-9 h-9 nexa-glass text-indigo-400 flex items-center justify-center text-xs shadow-lg border border-indigo-500/30"><i class="fas fa-file-pdf"></i></button>
            <button onclick="exportJSON()" class="w-9 h-9 nexa-glass text-blue-400 flex items-center justify-center text-xs"><i class="fas fa-database"></i></button>
            <label class="w-9 h-9 nexa-glass text-emerald-400 flex items-center justify-center text-xs cursor-pointer"><i class="fas fa-upload"></i><input type="file" class="hidden" accept=".json" onchange="importJSON(this)"></label>
            <button onclick="masterReset()" class="w-9 h-9 nexa-glass text-red-500 flex items-center justify-center text-xs"><i class="fas fa-power-off"></i></button>
        </div>
    </header>

    <div id="t-home" class="tab-content active-tab space-y-4">
        <div class="grid grid-cols-2 gap-3">
            <div class="nexa-glass p-6 text-center shadow-xl border-b-2 border-indigo-500/20"><h2 id="stCount" class="text-4xl font-black">0</h2><p class="text-[9px] text-slate-500 uppercase font-black">Total Students</p></div>
            <div class="nexa-glass bg-indigo-600/10 p-6 text-center shadow-xl border-b-2 border-indigo-500/40"><h2 id="revCount" class="text-3xl font-black text-indigo-400">â‚¹0</h2><p class="text-[9px] text-indigo-300/50 uppercase font-black">Total Revenue</p></div>
        </div>
        <div class="relative"><input type="text" id="hSearch" onkeyup="renderHome()" placeholder="Search Name, Batch, Subject..." class="pl-11 text-xs"><i class="fas fa-search absolute left-4 top-4 text-slate-600"></i></div>
        <div id="hList" class="space-y-3"></div>
    </div>

    <div id="t-add" class="tab-content space-y-4">
        <div class="nexa-glass p-6 space-y-3 shadow-2xl border-t-2 border-indigo-500">
            <input type="text" id="inN" placeholder="Full Student Name">
            <div class="grid grid-cols-2 gap-2"><input type="text" id="inB" placeholder="Batch Name"><input type="text" id="inC" placeholder="Subject"></div>
            <div class="grid grid-cols-2 gap-2"><input type="number" id="inF" placeholder="Fee Amount"><input type="number" id="inP" placeholder="WhatsApp No"></div>
            <div class="flex flex-col"><label class="text-[8px] text-slate-500 font-bold mb-1 uppercase">Joining Date</label><input type="date" id="inD"></div>
            <button onclick="saveStudent()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase italic shadow-lg mt-4">Save Admission</button>
        </div>
    </div>

    <div id="t-att" class="tab-content space-y-4">
        <div class="nexa-glass p-5">
            <div class="flex gap-2 mb-4"><input type="date" id="atDate" onchange="loadAtt()" class="!w-1/3 text-[10px]"><input type="text" id="atSearch" onkeyup="loadAtt()" placeholder="Search..." class="!w-2/3 text-xs"></div>
            <div id="atList" class="space-y-2 mb-4 max-h-60 overflow-y-auto pr-1"></div>
            <button onclick="saveAtt()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase text-xs">Lock Attendance</button>
            <hr class="border-white/5 my-6">
            <div class="flex gap-2 mb-2"><input type="date" id="fromD" class="text-[10px]"><input type="date" id="toD" class="text-[10px]"></div>
            <button onclick="exportAttendanceReport()" class="w-full bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 py-3 rounded-lg font-black text-[9px] uppercase">Attendance PDF</button>
        </div>
    </div>

    <div id="t-fees" class="tab-content space-y-4">
        <div class="nexa-glass p-5">
            <div class="flex justify-between items-center mb-4"><h3 class="text-[10px] font-black uppercase text-indigo-400 italic">Fee Management</h3><button onclick="waBulk()" class="bg-green-600/20 text-green-500 border border-green-500/30 px-4 py-2 rounded-lg text-[8px] font-black uppercase">Bulk WhatsApp</button></div>
            <input type="text" id="fSearch" onkeyup="renderFees()" placeholder="Search Students..." class="text-xs mb-4">
            <div id="fList" class="space-y-2"></div>
        </div>
    </div>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] nexa-glass p-2 flex justify-around shadow-2xl z-50 backdrop-blur-xl border-white/10">
        <button onclick="nav('home', this)" class="p-4 text-indigo-500"><i class="fas fa-home"></i></button>
        <button onclick="nav('add', this)" class="p-4 text-slate-500"><i class="fas fa-user-plus"></i></button>
        <button onclick="nav('att', this)" class="p-4 text-slate-500"><i class="fas fa-calendar-check"></i></button>
        <button onclick="nav('fees', this)" class="p-4 text-slate-500"><i class="fas fa-receipt"></i></button>
    </nav>
</div>

<script>
    const M_KEY = "Permanentkey63793119";
    const C_NAME = "MALHOTRA CLASSES (ACCOUNTS VILLA)";
    const C_ADDR = "Sant Nagar, Burari, Delhi-110084";
    let db, students = [], attData = {};

    function unlockApp() {
        if(document.getElementById("mKey").value.trim() === M_KEY) { localStorage.setItem("nexa_auth_status", "premium"); enterApp(); }
        else alert("ðŸš« Invalid Key!");
    }

    window.onload = () => {
        const now = Date.now(), savedStart = Number(localStorage.getItem("nexa_start_ts")), lastSeen = Number(localStorage.getItem("nexa_last_seen")) || now;
        if(now < lastSeen && !localStorage.getItem("nexa_auth_status")) localStorage.setItem("nexa_tampered", "true");
        localStorage.setItem("nexa_last_seen", now);
        if(!savedStart) localStorage.setItem("nexa_start_ts", now);
        const trialDays = Math.floor((now - (savedStart || now)) / 86400000), isTampered = localStorage.getItem("nexa_tampered") === "true";
        if(localStorage.getItem("nexa_auth_status") === "premium") enterApp();
        else if(trialDays >= 7 || isTampered) { document.getElementById("secMsg").innerText = isTampered ? "SECURITY LOCK" : "EXPIRED"; document.getElementById("secMsg").style.color="#f00"; }
        else { document.getElementById("secMsg").innerText = `TRIAL: ${7-trialDays} DAYS LEFT`; document.getElementById("trialArea").classList.remove("hidden"); }
    };

    function enterApp() { document.getElementById("lockScreen").style.display="none"; document.getElementById("appUI").style.display="block"; initDB(); }

    function initDB() {
        const req = indexedDB.open("MalhotraMaster_DB", 1);
        req.onupgradeneeded = e => { db=e.target.result; db.createObjectStore("st",{keyPath:"id"}); db.createObjectStore("at",{keyPath:"date"}); };
        req.onsuccess = e => { db=e.target.result; sync(); if(navigator.storage && navigator.storage.persist) navigator.storage.persist(); };
    }

    function sync() {
        const tx = db.transaction(["st","at"],"readonly");
        tx.objectStore("st").getAll().onsuccess = e => { students=e.target.result; updateUI(); };
        tx.objectStore("at").getAll().onsuccess = e => { e.target.result.forEach(r => attData[r.date]=r.data); loadAtt(); };
    }

    function updateUI() {
        let rev=0; students.forEach(s=>rev+=Number(s.fee));
        document.getElementById("stCount").innerText=students.length;
        document.getElementById("revCount").innerText=`â‚¹${rev}`;
        renderHome(); renderFees();
    }

    function renderHome() {
        const q=document.getElementById("hSearch").value.toLowerCase();
        const filt=students.filter(s=>s.name.toLowerCase().includes(q) || s.batch.toLowerCase().includes(q));
        document.getElementById("hList").innerHTML = filt.map(s=>`
            <div class="nexa-glass p-5 flex justify-between items-center border-l-4 border-indigo-500 shadow-lg">
                <div><p class="font-black text-sm uppercase italic">${s.name}</p><p class="text-[9px] text-slate-500 font-bold uppercase">${s.batch} | ${s.cls}</p><p class="text-[8px] text-indigo-400 font-black mt-1">Joined: ${s.date || 'N/A'}</p></div>
                <div class="flex gap-2"><a href="tel:${s.phone}" class="w-8 h-8 nexa-glass flex items-center justify-center text-blue-400 text-[10px]"><i class="fas fa-phone-alt"></i></a><button onclick="delSt(${s.id})" class="w-8 h-8 nexa-glass flex items-center justify-center text-red-500 text-[10px]"><i class="fas fa-trash"></i></button></div>
            </div>`).join("");
    }

    function saveStudent() {
        const s={ id:Date.now(), name:document.getElementById("inN").value, batch:document.getElementById("inB").value, cls:document.getElementById("inC").value, fee:document.getElementById("inF").value, phone:document.getElementById("inP").value, date:document.getElementById("inD").value || new Date().toISOString().split('T')[0] };
        if(!s.name || !s.phone) return alert("Fill Name & Phone!");
        const tx=db.transaction("st","readwrite"); tx.objectStore("st").add(s);
        tx.oncomplete=()=>{ sync(); alert("Saved!"); ["inN","inB","inC","inF","inP","inD"].forEach(i=>document.getElementById(i).value=""); };
    }

    function loadAtt() {
        const d=document.getElementById("atDate").value || new Date().toISOString().split('T')[0], q=document.getElementById("atSearch").value.toLowerCase(), saved=attData[d]||[], filt=students.filter(s=>s.name.toLowerCase().includes(q)||s.batch.toLowerCase().includes(q));
        document.getElementById("atList").innerHTML = filt.map(s=>{
            const isP=saved.length===0?true:(saved.find(x=>x.id===s.id)?.status==="P");
            return `<div class="flex justify-between items-center p-4 bg-white/5 rounded-xl mb-1 border-l-2 ${isP?'border-emerald-500':'border-red-500'}">
                <div><span class="text-xs font-black uppercase">${s.name}</span><p class="text-[8px] text-slate-500 uppercase">${s.batch}</p></div>
                <input type="checkbox" class="w-6 h-6 accent-indigo-500" data-id="${s.id}" ${isP?'checked':''}>
            </div>`;
        }).join("");
    }

    function saveAtt() {
        const d=document.getElementById("atDate").value, checks=Array.from(document.querySelectorAll("#atList input[type='checkbox']")).map(c=>({id:Number(c.dataset.id),status:c.checked?"P":"A"}));
        const tx=db.transaction("at","readwrite"); tx.objectStore("at").put({date:d,data:checks});
        tx.oncomplete=()=>{ attData[d]=checks; alert("Attendance Saved!"); };
    }

    function renderFees() {
        const q=document.getElementById("fSearch").value.toLowerCase(), filt=students.filter(s=>s.name.toLowerCase().includes(q)||s.batch.toLowerCase().includes(q));
        document.getElementById("fList").innerHTML=filt.map(s=>`
            <div class="nexa-glass p-4 flex justify-between items-center mb-2 shadow-md">
                <div class="flex items-center gap-3"><input type="checkbox" class="wa-sel w-5 h-5 accent-indigo-500" data-id="${s.id}"><p class="text-xs font-black uppercase">${s.name}</p></div>
                <button onclick='genInvoice(${JSON.stringify(s)})' class="text-indigo-400 text-xl"><i class="fas fa-file-invoice-dollar"></i></button>
            </div>`).join("");
    }

    // ðŸ† MASTER DATA PDF EXPORT (SUNDAR VERSION)
    function exportFullMasterPDF() {
        if(students.length === 0) return alert("No student data to export!");
        const { jsPDF }=window.jspdf; const doc=new jsPDF();
        doc.setFillColor(63, 81, 181); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(24); doc.text("MASTER STUDENT DIRECTORY", 105, 20, {align:"center"});
        doc.setFontSize(10); doc.text(C_NAME, 105, 30, {align:"center"});
        doc.text(C_ADDR, 105, 36, {align:"center"});
        const rows = students.map(s => [s.name.toUpperCase(), s.batch, s.cls, `INR ${s.fee}`, s.phone, s.date || 'N/A']);
        doc.autoTable({ startY: 45, head: [['NAME', 'BATCH', 'SUBJECT', 'FEE', 'PHONE', 'JOINED']], body: rows, headStyles:{fillColor:[45, 55, 72]}, theme: 'grid', styles: {fontSize: 8} });
        doc.setFontSize(8); doc.setTextColor(150); doc.text(`Generated by Khagesh ai-nexa | Total Students: ${students.length}`, 105, doc.lastAutoTable.finalY + 10, {align:"center"});
        doc.save(`Malhotra_Classes_Master_Report.pdf`);
    }

    function genInvoice(s) {
        const { jsPDF }=window.jspdf; const doc=new jsPDF();
        doc.setFillColor(31,41,55); doc.rect(0,0,210,45,'F');
        doc.setTextColor(255); doc.setFontSize(20); doc.text("FEE RECEIPT",105,20,{align:"center"});
        doc.setFontSize(10); doc.text(C_NAME,105,30,{align:"center"});
        doc.text(C_ADDR,105,36,{align:"center"});
        doc.autoTable({ startY:50, head:[['Description','Details']], body:[['Student',s.name.toUpperCase()],['Batch',s.batch],['Fee Paid',`INR ${s.fee}`],['Date',new Date().toLocaleDateString()]], headStyles:{fillColor:[31,41,55]}, theme:'grid' });
        doc.save(`${s.name}_Receipt.pdf`);
    }

    function exportAttendanceReport() {
        const f=document.getElementById("fromD").value, t=document.getElementById("toD").value; if(!f||!t) return alert("Select Range!");
        const { jsPDF }=window.jspdf; const doc=new jsPDF();
        doc.setFillColor(63,102,241); doc.rect(0,0,210,35,'F');
        doc.setTextColor(255); doc.setFontSize(18); doc.text("ATTENDANCE REPORT",105,15,{align:"center"});
        doc.setFontSize(8); doc.text(C_NAME, 105, 25, {align:"center"});
        const rows=[]; Object.keys(attData).sort().forEach(date=>{ if(date>=f&&date<=t) attData[date].forEach(e=>{ const s=students.find(x=>x.id===e.id); if(s) rows.push([date,s.name,s.batch,e.status]); }); });
        doc.autoTable({ startY:40, head:[['Date','Name','Batch','Status']], body:rows, headStyles:{fillColor:[31,41,55]} });
        doc.save(`Attendance_Report.pdf`);
    }

    function waBulk() {
        const sel=Array.from(document.querySelectorAll(".wa-sel:checked")); if(!sel.length) return alert("Select Students!");
        sel.forEach((cb,i)=>{ const s=students.find(x=>x.id==cb.dataset.id); setTimeout(()=>window.open(`https://wa.me/91${s.phone}?text=Hello ${s.name}, Fee INR ${s.fee} is pending at ${C_NAME}.`,'_blank'), i*3000); });
    }

    function exportJSON() {
        const data = JSON.stringify({st:students, at:Object.keys(attData).map(k=>({date:k,data:attData[k]}))});
        const a = document.createElement("a"); a.href=URL.createObjectURL(new Blob([data], {type: "application/json"})); a.download=`Malhotra_Backup.json`; a.click();
    }

    function importJSON(input) {
        const r=new FileReader(); r.onload=e=>{
            try {
                const d=JSON.parse(e.target.result); const tx=db.transaction(["st","at"],"readwrite");
                (d.st||[]).forEach(s=>tx.objectStore("st").put(s)); (d.at||[]).forEach(a=>tx.objectStore("at").put(a));
                tx.oncomplete=()=>{ alert("Import Successful!"); location.reload(); };
            } catch(err) { alert("Invalid File!"); }
        }; r.readAsText(input.files[0]);
    }

    function masterReset() { if(confirm("Wipe ALL data?")) { const tx=db.transaction(["st","at"],"readwrite"); tx.objectStore("st").clear(); tx.objectStore("at").clear(); tx.oncomplete=()=>{ localStorage.clear(); location.reload(); } } }
    function nav(t,b) { document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active-tab")); document.querySelectorAll("nav button").forEach(btn=>btn.classList.replace("text-indigo-500","text-slate-500")); document.getElementById("t-"+t).classList.add("active-tab"); b.classList.replace("text-slate-500","text-indigo-500"); }
    function delSt(id) { if(confirm("Delete student?")) { const tx=db.transaction("st","readwrite"); tx.objectStore("st").delete(id); tx.oncomplete=()=>sync(); } }
</script>
</body>
</html>
