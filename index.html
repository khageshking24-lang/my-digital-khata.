<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Malhotra Classes ERP | Master Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0e14; color: #fff; overflow-x: hidden; }
        .nexa-glass { background: #151921; border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; }
        .tab-content { display: none; }
        .active-tab { display: block; animation: slideUp 0.3s ease; }
        input { background: #1e232d !important; border: 1px solid #2d3545 !important; color: #fff !important; padding: 12px !important; border-radius: 12px !important; width: 100%; outline: none; transition: 0.3s; font-size: 13px !important; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .btn-gradient { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #2d3545; border-radius: 10px; }
    </style>
</head>
<body>

<div id="lockScreen" class="fixed inset-0 z-[9999] bg-[#0b0e14] flex items-center justify-center p-6">
    <div class="nexa-glass p-8 w-full max-w-sm text-center border-t-4 border-indigo-600 shadow-2xl">
        <h2 class="text-xl font-black text-indigo-500 mb-2 italic uppercase">Malhotra Classes</h2>
        <p class="text-[9px] text-slate-500 mb-8 uppercase font-bold tracking-widest italic">Sant Nagar Burari, Delhi</p>
        <div class="space-y-4">
            <input type="password" id="mKey" placeholder="Permanent Key" class="text-center font-bold tracking-widest">
            <button onclick="unlockApp()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase text-xs shadow-lg">Activate Premium</button>
        </div>
    </div>
</div>

<div id="appUI" class="p-4 max-w-lg mx-auto pb-40" style="display: none;">
    <header class="py-6 flex justify-between items-start">
        <div class="flex-1">
            <h1 class="text-lg font-black text-indigo-500 italic leading-none uppercase">Malhotra Classes</h1>
            <p class="text-[7px] text-slate-400 font-bold uppercase mt-1 leading-tight">Street No 112/10, B Block, Sant Nagar Burari, Delhi-110084</p>
            <p class="text-[6px] text-indigo-400/50 font-black uppercase tracking-[2px] mt-2 italic">Powered by Khagesh ai-nexa</p>
        </div>
        <div class="flex gap-1.5 shrink-0">
            <label class="w-8 h-8 nexa-glass text-emerald-400 flex items-center justify-center text-[10px] cursor-pointer"><i class="fas fa-file-import"></i><input type="file" accept=".csv" class="hidden" onchange="importCSV(event)"></label>
            <button onclick="exportCSV()" class="w-8 h-8 nexa-glass text-amber-500 flex items-center justify-center text-[10px]"><i class="fas fa-file-csv"></i></button>
            <button onclick="backupJSON()" class="w-8 h-8 nexa-glass text-blue-400 flex items-center justify-center text-[10px]"><i class="fas fa-download"></i></button>
        </div>
    </header>

    <div id="t-home" class="tab-content active-tab space-y-4">
        <div class="grid grid-cols-2 gap-3">
            <div class="nexa-glass p-6 text-center border-b-2 border-indigo-500/20 shadow-xl"><h2 id="stCount" class="text-4xl font-extrabold text-white">0</h2><p class="text-[8px] text-slate-500 uppercase font-bold tracking-widest mt-1">Total Students</p></div>
            <div class="nexa-glass bg-indigo-600/10 p-6 text-center border-b-2 border-indigo-500/40 shadow-xl"><h2 id="revCount" class="text-3xl font-extrabold text-indigo-400">₹0</h2><p class="text-[8px] text-indigo-300/50 uppercase font-bold tracking-widest mt-1">Expected Fee</p></div>
        </div>
        <div class="relative"><input type="text" id="hSearch" onkeyup="renderHome()" placeholder="Search Name, Batch, or Class..." class="pl-11"><i class="fas fa-search absolute left-4 top-4 text-slate-600 text-xs"></i></div>
        <div id="hList" class="space-y-3"></div>
    </div>

    <div id="t-add" class="tab-content space-y-4">
        <div class="nexa-glass p-6 space-y-3 border-t-2 border-indigo-500">
            <h3 class="text-[10px] font-black text-indigo-400 uppercase italic mb-2">Registration</h3>
            <input type="text" id="inN" placeholder="Student Name">
            <div class="grid grid-cols-2 gap-2"><input type="text" id="inB" placeholder="Batch Name"><input type="text" id="inC" placeholder="Class/Subject"></div>
            <div class="grid grid-cols-2 gap-2"><input type="number" id="inF" placeholder="Fee Amount"><input type="number" id="inP" placeholder="WhatsApp Number"></div>
            <div class="flex flex-col"><label class="text-[8px] text-slate-500 font-bold mb-1 ml-1 uppercase italic">Joining Date</label><input type="date" id="inD"></div>
            <button onclick="saveStudent()" class="w-full btn-gradient py-4 rounded-xl font-black uppercase text-xs italic shadow-lg mt-4">Save Enrollment</button>
        </div>
    </div>

    <div id="t-att" class="tab-content space-y-4">
        <div class="nexa-glass p-5 shadow-xl">
            <input type="date" id="atDate" onchange="loadAtt()" class="mb-3">
            <div class="relative mb-4"><input type="text" id="atSearch" onkeyup="loadAtt()" placeholder="Filter Class, Batch, or Name..." class="pl-11 border-indigo-500/20"><i class="fas fa-filter absolute left-4 top-4 text-indigo-500 text-xs"></i></div>
            <div id="atList" class="space-y-2 mb-4 max-h-80 overflow-y-auto"></div>
            <button onclick="saveAtt()" class="w-full btn-gradient py-3 rounded-xl font-black uppercase text-[10px]">Lock Attendance</button>
        </div>
        <div class="nexa-glass p-5 text-center border-dashed border-white/10">
            <div class="flex gap-2 mb-2"><input type="date" id="fromD"><input type="date" id="toD"></div>
            <button onclick="genAttendancePDF()" class="w-full bg-slate-800 text-indigo-400 py-3 rounded-xl font-black text-[9px] uppercase">Export Attendance PDF</button>
        </div>
    </div>

    <div id="t-fees" class="tab-content space-y-4">
        <div class="nexa-glass p-5 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[10px] font-black uppercase text-indigo-400 italic">Fee Tracker</h3>
                <button onclick="waBulkAuto()" class="bg-green-600/20 text-green-500 border border-green-500/30 px-4 py-2 rounded-lg text-[8px] font-black uppercase">Send Selected Bulk</button>
            </div>
            <div class="relative mb-4"><input type="text" id="fSearch" onkeyup="renderFees()" placeholder="Filter Class, Batch, or Name..." class="pl-11 border-indigo-500/20"><i class="fas fa-search-dollar absolute left-4 top-4 text-indigo-500 text-xs"></i></div>
            
            <div class="flex items-center gap-2 mb-3 ml-1">
                <input type="checkbox" id="selAll" onclick="selectAllFees(this)" class="w-4 h-4 accent-indigo-500 cursor-pointer">
                <label for="selAll" class="text-[9px] text-slate-400 uppercase font-black italic">Select All Visible</label>
            </div>

            <div id="fList" class="space-y-2"></div>
        </div>
    </div>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] nexa-glass p-2 flex justify-around shadow-2xl z-50 backdrop-blur-xl border-white/10">
        <button onclick="nav('home', this)" class="p-4 text-indigo-500"><i class="fas fa-home"></i></button>
        <button onclick="nav('add', this)" class="p-4 text-slate-500"><i class="fas fa-user-plus"></i></button>
        <button onclick="nav('att', this)" class="p-4 text-slate-500"><i class="fas fa-calendar-check"></i></button>
        <button onclick="nav('fees', this)" class="p-4 text-slate-500"><i class="fas fa-receipt"></i></button>
    </nav>
</div>

<script>
    const PKEY = "Permanentkey63793119";
    const CLIENT_NAME = "MALHOTRA CLASSES (ACCOUNTS VILLA)";
    const CLIENT_ADDR = "Street No 112/10, B Block, Sant Nagar Burari, Delhi-110084";
    let db, students = [], attData = {};

    function unlockApp() { if(document.getElementById("mKey").value === PKEY) { localStorage.setItem("nexa_ver", "true"); enterApp(); } else alert("Invalid Key!"); }
    function enterApp() { document.getElementById("lockScreen").style.display = "none"; document.getElementById("appUI").style.display = "block"; initDB(); }

    window.onload = () => { if(localStorage.getItem("nexa_ver") === "true") enterApp(); };

    function initDB() {
        const req = indexedDB.open("MalhotraFinalERP_v92", 1);
        req.onupgradeneeded = e => { db = e.target.result; db.createObjectStore("st", {keyPath: "id"}); db.createObjectStore("at", {keyPath: "date"}); };
        req.onsuccess = e => { db = e.target.result; sync(); if(navigator.storage && navigator.storage.persist) navigator.storage.persist(); };
    }

    function sync() {
        const tx = db.transaction(["st", "at"], "readonly");
        tx.objectStore("st").getAll().onsuccess = e => { students = e.target.result; updateUI(); };
        tx.objectStore("at").getAll().onsuccess = e => { e.target.result.forEach(r => attData[r.date] = r.data); loadAtt(); };
    }

    function updateUI() {
        let rv = 0; students.forEach(s => rv += Number(s.fee));
        document.getElementById("stCount").innerText = students.length;
        document.getElementById("revCount").innerText = `₹${rv}`;
        renderHome(); renderFees();
    }

    function renderHome() {
        const q = document.getElementById("hSearch").value.toLowerCase();
        const filt = students.filter(s => s.name.toLowerCase().includes(q) || s.batch.toLowerCase().includes(q) || s.cls.toLowerCase().includes(q));
        document.getElementById("hList").innerHTML = filt.map(s => `
            <div class="nexa-glass p-5 flex justify-between items-center shadow-lg border-l-4 border-indigo-500">
                <div><p class="font-black text-sm text-white uppercase italic leading-tight">${s.name}</p>
                <p class="text-[8px] text-slate-500 font-bold uppercase tracking-widest">${s.batch} | ${s.cls}</p>
                <p class="text-[7px] text-indigo-400 font-bold mt-1 uppercase italic">Joined: ${s.date || '---'}</p></div>
                <div class="flex gap-2">
                    <a href="tel:${s.phone}" class="w-8 h-8 bg-indigo-500/10 text-indigo-400 flex items-center justify-center rounded-full text-[10px]"><i class="fas fa-phone-alt"></i></a>
                    <button onclick="delSt(${s.id})" class="w-8 h-8 bg-red-500/10 text-red-500 flex items-center justify-center rounded-full text-[10px]"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`).join("");
    }

    function saveStudent() {
        const s = { id: Date.now(), name: document.getElementById("inN").value, batch: document.getElementById("inB").value, cls: document.getElementById("inC").value, fee: document.getElementById("inF").value, phone: document.getElementById("inP").value, date: document.getElementById("inD").value || new Date().toISOString().split('T')[0] };
        if(!s.name || !s.phone) return alert("Required: Name & Phone");
        const tx = db.transaction("st", "readwrite");
        tx.objectStore("st").add(s);
        tx.oncomplete = () => location.reload();
    }

    function loadAtt() {
        const d = document.getElementById("atDate").value || new Date().toISOString().split('T')[0];
        document.getElementById("atDate").value = d;
        const q = document.getElementById("atSearch").value.toLowerCase();
        const saved = attData[d] || [];
        const filt = students.filter(s => s.name.toLowerCase().includes(q) || s.batch.toLowerCase().includes(q) || s.cls.toLowerCase().includes(q));
        document.getElementById("atList").innerHTML = filt.map(s => {
            const isP = saved.length === 0 ? true : (saved.find(x => x.id === s.id)?.status === "P");
            return `<div class="flex justify-between items-center p-4 bg-white/5 rounded-xl mb-1 border-l-2 ${isP ? 'border-emerald-500' : 'border-red-500'}">
                <div><span class="text-xs font-black uppercase text-white">${s.name}</span><p class="text-[8px] text-slate-500 uppercase font-bold">${s.batch} | ${s.cls}</p></div>
                <input type="checkbox" class="w-6 h-6 accent-indigo-500" data-id="${s.id}" ${isP ? 'checked' : ''}>
            </div>`;
        }).join("");
    }

    function saveAtt() {
        const d = document.getElementById("atDate").value;
        const checks = Array.from(document.querySelectorAll("#atList input[type='checkbox']")).map(c => ({ id: Number(c.dataset.id), status: c.checked ? "P" : "A" }));
        const tx = db.transaction("at", "readwrite");
        tx.objectStore("at").put({ date: d, data: checks });
        tx.oncomplete = () => { attData[d] = checks; alert("Attendance Saved!"); };
    }

    function renderFees() {
        const q = document.getElementById("fSearch").value.toLowerCase();
        const filt = students.filter(s => s.name.toLowerCase().includes(q) || s.batch.toLowerCase().includes(q) || s.cls.toLowerCase().includes(q));
        document.getElementById("fList").innerHTML = filt.map(s => `
            <div class="nexa-glass p-4 flex justify-between items-center mb-2 shadow-lg border-l-2 border-indigo-500/30">
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="wa-bulk-check w-5 h-5 accent-indigo-500 cursor-pointer" data-id="${s.id}">
                    <div><p class="text-xs font-black uppercase text-white">${s.name}</p><p class="text-[8px] text-slate-500 uppercase font-bold">${s.batch} | ${s.cls}</p></div>
                </div>
                <button onclick='genInvoice(${JSON.stringify(s)})' class="text-indigo-400 text-xl"><i class="fas fa-file-invoice-dollar"></i></button>
            </div>`).join("");
    }

    function selectAllFees(el) { document.querySelectorAll('.wa-bulk-check').forEach(c => c.checked = el.checked); }

    function waBulkAuto() {
        const selected = Array.from(document.querySelectorAll('.wa-bulk-check:checked'));
        if(selected.length === 0) return alert("Pehle students select karein!");
        
        if(confirm(`Kya aap ${selected.length} students ko auto-reminders bhejna chahte hain?`)) {
            selected.forEach((chk, index) => {
                const s = students.find(x => x.id == chk.dataset.id);
                setTimeout(() => {
                    const msg = encodeURIComponent(`Hello ${s.name}, Fee reminder from ${CLIENT_NAME}. Your due is ₹${s.fee}.\nAddress: ${CLIENT_ADDR}.`);
                    window.open(`https://wa.me/91${s.phone}?text=${msg}`, '_blank');
                }, index * 2500); 
            });
        }
    }

    function genInvoice(s) {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFillColor(63, 102, 241); doc.rect(0, 0, 210, 55, 'F');
        doc.setTextColor(255); doc.setFontSize(22); doc.text("FEE RECEIPT", 105, 20, {align:"center"});
        doc.setFontSize(10); doc.text(CLIENT_NAME, 105, 32, {align:"center"});
        doc.setFontSize(8); doc.text(CLIENT_ADDR, 105, 40, {align:"center"});
        doc.autoTable({ startY: 65, head: [['Description', 'Details']], body: [['Student', s.name.toUpperCase()], ['Batch', s.batch], ['Class', s.cls], ['Total Paid', `INR ${s.fee}`]], headStyles: {fillColor:[31, 41, 55]} });
        doc.setTextColor(160); doc.setFontSize(8); doc.text("Digitally Managed by Khagesh ai-nexa", 105, 285, {align:"center"});
        doc.save(`${s.name}_Receipt.pdf`);
    }

    function genAttendancePDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const f = document.getElementById("fromD").value, t = document.getElementById("toD").value;
        if(!f || !t) return alert("Select Dates!");
        doc.setFillColor(31, 41, 55); doc.rect(0, 0, 210, 45, 'F');
        doc.setTextColor(255); doc.setFontSize(16); doc.text(CLIENT_NAME, 105, 15, {align:"center"});
        doc.setFontSize(8); doc.text(CLIENT_ADDR, 105, 23, {align:"center"});
        const rows = [];
        Object.keys(attData).sort().forEach(date => {
            if(date >= f && date <= t) attData[date].forEach(e => { const s = students.find(x => x.id === e.id); if(s) rows.push([date, s.name, s.batch, s.cls, e.status]); });
        });
        doc.autoTable({ startY: 50, head: [['Date', 'Name', 'Batch', 'Class', 'Status']], body: rows, headStyles:{fillColor:[63, 81, 181]} });
        doc.save(`Attendance_Report.pdf`);
    }

    function nav(t, b) {
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active-tab"));
        document.querySelectorAll("nav button").forEach(btn => btn.classList.replace("text-indigo-500", "text-slate-500"));
        document.getElementById("t-"+t).classList.add("active-tab");
        b.classList.replace("text-slate-500", "text-indigo-500");
    }

    function delSt(id) { if(confirm("Delete Record?")) { const tx = db.transaction("st", "readwrite"); tx.objectStore("st").delete(id); tx.oncomplete = () => { students = students.filter(s => s.id !== id); updateUI(); }; } }
    function exportCSV() { let csv = "Name,Batch,Class,Fee,Phone,JoiningDate\n" + students.map(s => `${s.name},${s.batch},${s.cls},${s.fee},${s.phone},${s.date}`).join("\n"); const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = `MalhotraClasses_DB.csv`; a.click(); }
    function backupJSON() { const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify({st:students, at:attData})], {type: "application/json"})); a.download = `Malhotra_Full_Backup.json`; a.click(); }
    function importCSV(ev) { const file = ev.target.files[0]; const reader = new FileReader(); reader.onload = e => { const lines = e.target.result.split("\n").slice(1); const tx = db.transaction("st", "readwrite"); lines.forEach((l, i) => { const c = l.split(","); if(c.length >= 5) tx.objectStore("st").put({ id: Date.now()+i, name: c[0].trim(), batch: c[1].trim(), cls: c[2].trim(), fee: c[3].trim(), phone: c[4].trim(), date: c[5]?.trim() || "" }); }); tx.oncomplete = () => location.reload(); }; reader.readAsText(file); }
</script>
</body>
</html>
